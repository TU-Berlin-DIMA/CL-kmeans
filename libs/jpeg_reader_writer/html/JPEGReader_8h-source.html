<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>JPEGReader.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>JPEGReader.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef AJS_JPEG_READER_H</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define AJS_JPEG_READER_H</span>
00003 <span class="preprocessor"></span>
00004 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00005 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
00006 <span class="preprocessor">#include &lt;cassert&gt;</span>
00007 
00008 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
00009 <span class="preprocessor">    #include &lt;jpeglib.h&gt;</span>
00010 <span class="preprocessor">    #include &lt;jerror.h&gt;</span>
00011 }
00012 
00013 <span class="preprocessor">#include &lt;vector&gt;</span>
00014 <span class="preprocessor">#include &lt;string&gt;</span>
00015 
00016 <span class="preprocessor">#include "JPEG.h"</span>
00017 
<a name="l00022"></a><a class="code" href="classJPEGReader.html">00022</a> <span class="keyword">class </span><a class="code" href="classJPEGReader.html">JPEGReader</a> {
00023     <span class="keyword">public</span>:
00024         
00026     <a class="code" href="classJPEGReader.html#a0">JPEGReader</a>();
00027     
00029     <a class="code" href="classJPEGReader.html#a1">~JPEGReader</a>();
00030     
00033     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#a2">header</a>(<span class="keyword">const</span> std::string&amp; path);
00034     
00036     <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a3">width</a>() <span class="keyword">const</span>;    
00037     
00039     <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a4">height</a>() <span class="keyword">const</span>;   
00040     
00048     <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a5">components</a>() <span class="keyword">const</span>;  
00049     
00052     <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a6">colorComponents</a>() <span class="keyword">const</span>;
00053     
00071     <span class="keyword">const</span> std::vector&lt;unsigned char&gt;&amp; <a class="code" href="classJPEGReader.html#a7">colormap</a>() <span class="keyword">const</span>;
00072     
00074     JPEG::Scale <a class="code" href="classJPEGReader.html#a8">scale</a>() <span class="keyword">const</span>;
00075     
00077     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#a9">setScale</a>(<span class="keyword">const</span> JPEG::Scale value);
00078     
00081     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#a10">chooseGoodScale</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> targetWidth, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> targetHeight);
00082     
00084     JPEG::ColorSpace <a class="code" href="classJPEGReader.html#a11">colorSpace</a>() <span class="keyword">const</span>;
00085     
00087     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#a12">setColorSpace</a>(<span class="keyword">const</span> JPEG::ColorSpace value);
00088     
00090     JPEG::Dither <a class="code" href="classJPEGReader.html#a13">dither</a>() <span class="keyword">const</span>;
00091     
00093     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#a14">setDither</a>(<span class="keyword">const</span> JPEG::Dither&amp; value);
00094     
00096     <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a15">quantization</a>() <span class="keyword">const</span>;
00097     
00100     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#a16">setQuantization</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> value);
00101     
00103     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#a17">setTradeoff</a>(<span class="keyword">const</span> JPEG::TimeQualityTradeoff value);
00104 
00105     
00108     
00110     <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#z0_0">numRecommendedRowPtrs</a>() <span class="keyword">const</span>;
00111     
00113     <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#z0_1">maxRowPtrs</a>() <span class="keyword">const</span>;   
00114     
00116     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#z0_2">setMaxRowPtrs</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> value);
00117     
00118     
00119     
00180     <span class="keyword">template</span> &lt;<span class="keyword">typename</span> RowPtrIter&gt;
00181     <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#z0_3">load</a>(RowPtrIter rows);
00182     
00184     
00187     <span class="keyword">const</span> std::string&amp; <a class="code" href="classJPEGReader.html#a18">warnings</a>() <span class="keyword">const</span>;
00188     
00189     
00190 <span class="preprocessor">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>
00191 <span class="preprocessor"></span>
00192     <span class="keywordtype">void</span> error_exit();
00193     
00195     <span class="keywordtype">void</span> output_message();
00196 <span class="preprocessor">#endif</span>
00197 <span class="preprocessor"></span>    
00198     <span class="keyword">private</span>:
00199     <span class="comment">// Disallow copying</span>
00200     <a class="code" href="classJPEGReader.html#a0">JPEGReader</a>(<span class="keyword">const</span> <a class="code" href="classJPEGReader.html">JPEGReader</a>&amp; other);
00201     <a class="code" href="classJPEGReader.html">JPEGReader</a>&amp; operator=(<span class="keyword">const</span> <a class="code" href="classJPEGReader.html">JPEGReader</a>&amp; other);
00202     
00204     <span class="keyword">template</span> &lt;<span class="keyword">typename</span> RowIter&gt;
00205     <span class="keywordtype">void</span> fill(RowIter&amp; rows, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> count, <span class="keywordtype">bool</span> first_row);
00206     
00207     <span class="keyword">struct </span>jpeg_decompress_struct cinfo;        
00208     <span class="keyword">struct </span>jpeg_error_mgr jerr;                 
00209     
00210     FILE* file;                                 
00211     <span class="keywordtype">unsigned</span> max_row_ptrs;                      
00212     std::vector&lt;unsigned char*&gt; row_ptrs;       
00213     
00214     std::vector&lt;unsigned char&gt; cmap;            
00215     std::string warningMsg;                     
00216 };
00217 
<a name="l00218"></a><a class="code" href="classJPEGReader.html#a3">00218</a> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a3">JPEGReader::width</a>()<span class="keyword"> const </span>{
00219     <span class="keywordflow">return</span> cinfo.output_width;
00220 }
00221 
<a name="l00222"></a><a class="code" href="classJPEGReader.html#a4">00222</a> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a4">JPEGReader::height</a>()<span class="keyword"> const </span>{
00223     <span class="keywordflow">return</span> cinfo.output_height;
00224 }
00225 
<a name="l00226"></a><a class="code" href="classJPEGReader.html#a5">00226</a> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a5">JPEGReader::components</a>()<span class="keyword"> const </span>{
00227     <span class="keywordflow">return</span> cinfo.output_components;
00228 }
00229 
<a name="l00230"></a><a class="code" href="classJPEGReader.html#a6">00230</a> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#a6">JPEGReader::colorComponents</a>()<span class="keyword"> const </span>{
00231     <span class="keywordflow">return</span> cinfo.out_color_components;
00232 }
00233 
<a name="l00234"></a><a class="code" href="classJPEGReader.html#a7">00234</a> <span class="keyword">inline</span> <span class="keyword">const</span> std::vector&lt;unsigned char&gt;&amp; <a class="code" href="classJPEGReader.html#a7">JPEGReader::colormap</a>()<span class="keyword"> const </span>{
00235     <span class="keywordflow">return</span> cmap;
00236 }
00237 
<a name="l00238"></a><a class="code" href="classJPEGReader.html#z0_0">00238</a> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#z0_0">JPEGReader::numRecommendedRowPtrs</a>()<span class="keyword"> const </span>{
00239     <span class="keywordflow">return</span> cinfo.rec_outbuf_height;
00240 }
00241 
<a name="l00242"></a><a class="code" href="classJPEGReader.html#z0_1">00242</a> <span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <a class="code" href="classJPEGReader.html#z0_1">JPEGReader::maxRowPtrs</a>()<span class="keyword"> const </span>{
00243     <span class="keywordflow">return</span> max_row_ptrs;
00244 }
00245 
<a name="l00246"></a><a class="code" href="classJPEGReader.html#z0_2">00246</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#z0_2">JPEGReader::setMaxRowPtrs</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> value) {
00247     assert(value &gt; 0);
00248     max_row_ptrs = value;
00249 }
00250 
<a name="l00251"></a><a class="code" href="classJPEGReader.html#a18">00251</a> <span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; <a class="code" href="classJPEGReader.html#a18">JPEGReader::warnings</a>()<span class="keyword"> const </span>{
00252     <span class="keywordflow">return</span> warningMsg;
00253 }
00254 
00255 
00256 
00257 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> RowIter&gt;
00258 <span class="keywordtype">void</span> JPEGReader::fill(RowIter&amp; rows, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> count, <span class="keywordtype">bool</span> first_row) {
00259     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; count; ++i) {
00260         <span class="keywordflow">if</span> (!first_row)
00261             ++rows;
00262         row_ptrs[i] = *rows;
00263         first_row = <span class="keyword">false</span>;
00264     }
00265 }
00266 
00267 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> RowPtrIter&gt;
<a name="l00268"></a><a class="code" href="classJPEGReader.html#z0_3">00268</a> <span class="keywordtype">void</span> <a class="code" href="classJPEGReader.html#z0_3">JPEGReader::load</a>(RowPtrIter rows) {
00269     <span class="comment">// Start the decompression</span>
00270     jpeg_start_decompress(&amp;cinfo);
00271     
00272     <span class="comment">// Get the initial row pointers</span>
00273     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> num_row_ptrs = std::min(max_row_ptrs, <a class="code" href="classJPEGReader.html#z0_0">numRecommendedRowPtrs</a>());
00274     row_ptrs.resize(num_row_ptrs, NULL);
00275     fill(rows, num_row_ptrs, <span class="keyword">true</span>);
00276     
00277     <span class="keywordtype">unsigned</span> base = 0;
00278     <span class="keywordflow">while</span> (cinfo.output_scanline &lt; cinfo.output_height) {
00279         assert(cinfo.output_scanline &gt;= base &amp;&amp; cinfo.output_scanline &lt;= base + num_row_ptrs);
00280         
00281         <span class="comment">// Get some new row pointers from the user</span>
00282         <span class="keywordflow">if</span> (cinfo.output_scanline == base + num_row_ptrs) {
00283             fill(rows, num_row_ptrs, <span class="keyword">false</span>);
00284             base += num_row_ptrs;
00285         }
00286         assert(cinfo.output_scanline &gt;= base &amp;&amp; cinfo.output_scanline &lt; base + num_row_ptrs);
00287         
00288         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> index = cinfo.output_scanline - base;
00289         assert(index &gt;= 0 &amp;&amp; index &lt; num_row_ptrs);
00290         jpeg_read_scanlines(&amp;cinfo, &amp;row_ptrs[index], num_row_ptrs - index);
00291     }
00292     
00293     <span class="comment">// Copy color map before jpeg_finish_decompress() nukes it.</span>
00294     cmap.resize(cinfo.actual_number_of_colors * cinfo.out_color_components);
00295     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cinfo.out_color_components; ++i) 
00296         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; cinfo.actual_number_of_colors; ++j) 
00297             cmap[j * cinfo.out_color_components + i] = cinfo.colormap[i][j];
00298     
00299     jpeg_finish_decompress(&amp;cinfo);
00300 }
00301 
00302 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon Jul 13 10:43:01 2009 by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
